<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Metadata and linking the CSS file -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Battle: Dungeons of Knowledge - Game</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    {% if settings.sound_effects %}
    <!-- Sound Effects -->
    <audio id="correctSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/correct.mp3') }}" type="audio/mpeg">
        <source src="{{ url_for('static', filename='sounds/correct.wav') }}" type="audio/wav">
    </audio>
    <audio id="wrongSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/wrong.mp3') }}" type="audio/mpeg">
        <source src="{{ url_for('static', filename='sounds/wrong.wav') }}" type="audio/wav">
    </audio>
    <audio id="tickSound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/tick.mp3') }}" type="audio/mpeg">
        <source src="{{ url_for('static', filename='sounds/tick.wav') }}" type="audio/wav">
    </audio>
    {% endif %}
    <style>
        body { 
            font-family: 'Times New Roman', Times, serif; 
            background: #2e3d1f; 
            color: #f3eac2; 
            margin: 0;
            padding: 20px;
        }
        .game-container { 
            max-width: 800px; 
            margin: 20px auto; 
            background: #f3eac2; 
            border: 6px solid #4b2e05; 
            border-radius: 24px; 
            box-shadow: 0 0 24px #0008; 
            padding: 32px 24px 24px 24px; 
            text-align: center; 
        }
        .game-title {
            color: #4b2e05; 
            font-size: 2.5em; 
            font-weight: bold; 
            background: #fffbe6; 
            border-radius: 16px; 
            padding: 18px 0 14px 0; 
            margin-bottom: 18px;
            letter-spacing: 2px;
        }
        .timer { 
            font-size: 1.3em; 
            color: #b22222; 
            margin-bottom: 12px; 
        }
        .questions-left { 
            font-size: 1.2em; 
            color: #4b2e05; 
            background: #ffeebc;
            border-radius: 10px;
            padding: 10px 0;
            margin-bottom: 18px;
        }
        .character-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 20px;
        }
        .character-info {
            flex: 1;
            text-align: center;
        }
        .character-avatar {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: contain;
            border: 3px solid #4b2e05;
            margin-bottom: 8px;
        }
        .character-avatar.placeholder {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            background: #fffbe6;
            color: #4b2e05;
            border-radius: 12px;
            border: 3px solid #4b2e05;
        }
        .character-name {
            font-weight: bold;
            color: #4b2e05;
            margin-bottom: 5px;
        }
        .hp-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #4b2e05;
            margin-bottom: 5px;
        }
        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            text-align: center;
            line-height: 16px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .enemy-hp-fill {
            background: linear-gradient(90deg, #f44336, #ff9800);
        }
        .question {
            font-size: 1.4em; 
            margin: 24px 0; 
            color: #4b2e05; 
            background: #fffbe6; 
            border-radius: 12px; 
            padding: 18px 12px; 
            box-shadow: 0 2px 8px #0002; 
        }
        .btn { 
            font-family: 'Times New Roman', Times, serif;
            background: #4b2e05;
            color: #f3eac2;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 10px;
        }
        .btn:hover {
            background: #6d4106;
        }
        input[type="text"] {
            font-family: 'Times New Roman', Times, serif;
            padding: 12px;
            border: 2px solid #4b2e05;
            border-radius: 8px;
            font-size: 1em;
            width: 300px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <!-- Main container for the game content -->
    <div class="game-container animation-{{ settings.animation_speed or 'normal' }} fade-in">
        <!-- Game Title -->
        <h1 class="game-title slide-in">‚öîÔ∏è Battle Arena</h1>
        
        <!-- Timer (shown based on settings) -->
        {% if settings.show_timer %}
        <div class="timer" id="timer">‚è±Ô∏è Time Left: {{ time_left }} seconds</div>
        {% endif %}

        <!-- Questions Progress (shown based on settings) -->
        {% if settings.show_progress %}
        <div class="questions-left">Question {{ q_number }} of {{ total }} | Level {{ level }}</div>
        {% endif %}
        
        <!-- Lives System (if enabled) -->
        {% if lives_enabled %}
        <div class="lives-display" style="text-align: center; color: #4b2e05; font-weight: bold; margin: 10px 0;">
            ‚ù§Ô∏è Lives: {{ lives_remaining }} / {{ settings.max_lives }}
        </div>
        {% endif %}
        
        <!-- Character Stats Section -->
        <div class="character-stats">
            <!-- Player Info -->
            <div class="character-info">
                {% if session.get('character') %}
                <img class="character-avatar" src="{{ url_for('static', filename='characters/character' ~ session.get('character') ~ '.png') }}" alt="Player avatar">
                {% else %}
                <div class="character-avatar placeholder">üßë</div>
                {% endif %}
                <div class="character-name">Player</div>
                <div class="hp-bar">
                    <div class="hp-fill" style="width: {{ player_hp }}%;">{{ player_hp }}/100 HP</div>
                </div>
                <div style="color: #4b2e05; font-weight: bold;">‚≠ê Score: {{ score }}</div>
            </div>
            
            <!-- Enemy Info -->
            <div class="character-info">
                {% if enemy_image %}
                    <img class="character-avatar" src="{{ enemy_image }}" alt="Enemy avatar">
                {% else %}
                    <div class="character-avatar placeholder">{{ enemy.avatar }}</div>
                {% endif %}
                <div class="character-name">{{ enemy.name }}</div>
                <div class="hp-bar">
                    <div class="hp-fill enemy-hp-fill" style="width: {{ enemy_hp }}%;">{{ enemy_hp }}/100 HP</div>
                </div>
                <div style="color: #4b2e05; font-style: italic;">"{{ enemy.taunt }}"</div>
            </div>
        </div>

        <!-- Question Section -->
        <div class="question">{{ question['q'] }}</div>
        
        {% if settings.debug_mode %}
        <!-- Debug Information -->
        <div style="background: #ffeeee; border: 2px solid #ff0000; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 0.9em; color: #333;">
            <strong>üêõ DEBUG MODE</strong><br>
            <strong>Answer:</strong> {{ question.answer }}<br>
            <strong>Keywords:</strong> {{ question.keywords }}<br>
            <strong>Question ID:</strong> {{ question.id }}<br>
            <strong>Session Timer:</strong> {{ session.get('current_timer', 'N/A') }}s<br>
            <strong>Time Left:</strong> {{ time_left }}s<br>
            <strong>Q Index:</strong> {{ session.get('q_index', 0) }}/{{ total }}<br>
            <strong>Adaptive Difficulty:</strong> {{ settings.adaptive_difficulty }}<br>
            <strong>Performance:</strong> {{ session.get('correct_answers', 0) }}C / {{ session.get('wrong_answers', 0) }}W
        </div>
        {% endif %}
        
        <!-- Answer Form -->
        <form method="POST">
            <input type="text" name="answer" placeholder="Type your answer..." required>
            <button type="submit" class="btn">Attack!</button>
        </form>
    </div>

    <script>
        // Initialize the remaining time from the backend
        let timeLeft = {{ time_left }};
        const timerElement = document.getElementById("timer");

        // Countdown logic to update the timer every second
        const countdown = setInterval(() => {
            if (timeLeft > 0) {
                // Decrease the time left and update the timer text
                timeLeft--;
                if (timerElement) {
                    timerElement.innerText = "‚è±Ô∏è Time Left: " + timeLeft + " seconds";
                }
            } else {
                // Stop the countdown when time reaches 0
                clearInterval(countdown);
                if (timerElement) {
                    timerElement.innerText = "‚è≥ Time's up!";
                }
                // Redirect to refresh the page and trigger server-side timeout logic
                window.location.reload();
            }
            
            {% if settings.sound_effects %}
            // Play tick sound every 5 seconds when time is running low
            if (timeLeft <= 10 && timeLeft % 5 === 0) {
                const tickSound = document.getElementById('tickSound');
                if (tickSound) {
                    tickSound.play().catch(e => console.log('Could not play tick sound:', e));
                }
            }
            {% endif %}
        }, 1000); // Run the function every 1000ms (1 second)
        
        {% if settings.sound_effects %}
        // Add sound effects to form submission
        document.querySelector('form').addEventListener('submit', function(e) {
            // Don't prevent form submission, just play sound
            // We can't determine if answer is correct here, so we'll add sounds to feedback page
        });
        {% endif %}
    </script>
</body>
</html>
